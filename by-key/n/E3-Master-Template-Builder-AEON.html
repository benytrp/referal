<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>E3 Master Template Builder — offline (+ AEON Bridge v1.1)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--ink:#111;--muted:#586174;--rule:#d8dee9;--accent:#0e7afe;--bg:#fcfdff}
    *{box-sizing:border-box}
    body{font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:18px; color:var(--ink); background:var(--bg)}
    h1{margin:0 0 8px 0; font-size:18px}
    h3{margin:0 0 8px 0}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    .card{border:1px solid var(--rule); background:#fff; border-radius:8px; padding:12px}
    label small{color:var(--muted)}
    input[type="text"], input[type="number"], textarea{width:100%; padding:8px; border:1px solid var(--rule); border-radius:6px; font:inherit}
    textarea#editor{height:360px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12.5px}
    textarea#dataJson{height:160px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12.5px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{background:var(--accent); border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:600}
    .btn.secondary{background:#0b5ed7}
    .btn.ghost{background:#eef5ff; color:#0b5ed7}
    .muted{color:var(--muted)}
    .log{border:1px dashed var(--rule); min-height:60px; padding:8px; white-space:pre-wrap; background:#fafcff; border-radius:6px; font-family: ui-monospace, monospace; font-size:12px}
    iframe#preview{width:100%; height:420px; border:1px solid var(--rule); border-radius:6px; background:#fff}
    .mono{font-family: ui-monospace, monospace}
    .pill{padding:2px 8px; border:1px solid var(--rule); border-radius:999px; background:#f5f8ff; font-size:12px}
  </style>
</head>
<body>
  <h1>E3 Master Template Builder <span class="muted">(+ AEON-Bridge v1.1)</span></h1>
  <p class="muted">Generate child evaluation pages (offline). Master assigns unique identifiers; child pages pre-check boxes from your data. Optionally emit an AEON-Bridge v1.1 checklist JSON (sealed).</p>

  <div class="grid">
    <!-- Identifiers -->
    <div class="card">
      <h3>Identifiers</h3>
      <div class="row">
        <label>Batch ID<br><input id="batchId" type="text" class="mono" value="" /></label>
        <button class="btn ghost" id="regenBatch">Generate</button>
        <label>Instance start #<br><input id="instanceStart" type="number" min="1" value="1" /></label>
        <label><input id="autoIds" type="checkbox" checked> Auto-assign IDs per child</label>
      </div>
      <div class="row">
        <label>Test iterations<br><input id="testCount" type="number" min="10" value="200"/></label>
        <button class="btn" id="testIds">Test generator</button>
      </div>
      <div class="log" id="testLog">Waiting to test…</div>
    </div>

    <!-- Data -->
    <div class="card">
      <h3>Data</h3>
      <div class="row">
        <input type="file" id="bulkFile" accept=".json">
        <span class="pill">Bulk: JSON array</span>
      </div>
      <label>Base data (JSON object — optional)<br>
        <textarea id="dataJson" placeholder='{"record_meta": {"date":"2025-08-09"}}'></textarea>
      </label>
      <p class="muted">During bulk export, each row overlays this base data. Allowed precheck values: yes/ni/na (also y/true/1 → yes; no/false/0 → ni; n/a/na → na).</p>
    </div>

    <!-- Child template -->
    <div class="card">
      <h3>Child template</h3>
      <div class="row">
        <button class="btn ghost" id="resetTpl">Reset to default E3 template</button>
      </div>
      <textarea id="editor"></textarea>
    </div>

    <!-- Actions -->
    <div class="card">
      <h3>Actions</h3>
      <label>File name pattern (tokens allowed)<br>
        <input id="filePattern" type="text" class="mono" value="E3-⟦record_meta.participant_code⟧-⟦record_meta.date⟧-⟦record_meta.eval_id⟧.html">
      </label>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnPreview">Preview</button>
        <button class="btn secondary" id="btnDownloadOne">Download Child</button>
        <button class="btn" id="btnBulk">Bulk Export</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label><input id="emitChecklist" type="checkbox" checked> Emit AEON-Bridge v1.1 checklist JSON with each child</label>
      </div>
      <iframe id="preview"></iframe>
    </div>
  </div>

  <!-- Default child template -->
  <script type="text/plain" id="defaultChild">
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>E3 Achievement — Daily Participant Evaluation (Checkbox Template)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --ink:#111; --muted:#555; --rule:#cfd6df; --accent:#0e7afe; --pad:10px; }
    *{box-sizing:border-box}
    body{ font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); margin:24px; background:#fff; }
    h1{ text-align:center; font-size:18px; margin:0 0 12px 0; text-transform:uppercase; letter-spacing:.5px; }
    .row{display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:12px; margin-bottom:8px}
    .field{ border-bottom:1px solid var(--rule); padding:6px 4px; display:flex; gap:6px; align-items:baseline; min-height:30px; }
    .label{color:var(--muted); min-width:max-content}
    .value{flex:1; font-weight:600}
    .section{margin-top:18px; border-top:2px solid var(--ink); padding-top:8px}
    .section h2{font-size:15px; margin:0 0 6px 0}
    table{width:100%; border-collapse:collapse; margin:6px 0 10px 0; table-layout:fixed}
    th, td{border:1px solid var(--rule); padding:6px 8px; vertical-align:middle}
    th{background:#f6f7f9; font-weight:700; text-align:left}
    .w-40 {width:40%}
    .note{border:1px dashed var(--rule); padding:8px; min-height:48px; color:#222; background:#fcfdff}
    .small{font-size:12px; color:#888}
    .sign-row{display:grid; grid-template-columns: 2fr 1fr 1fr; gap:12px; margin-top:8px}
    .counts{display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px}
    .muted{color:#666}
    @media print{
      body{margin:0; font-size:12px}
      .no-print.controls{display:none !important}
      input[type="checkbox"]{ transform: scale(1.2); }
    }
    .chkcell{ text-align:center }
    .chkwrap{ display:inline-flex; align-items:center; gap:6px; justify-content:center }
    .chkwrap input[type="checkbox"]{ width:18px; height:18px }
    .legend{display:flex; gap:16px; align-items:center; margin:6px 0 0 0; color:#666; font-size:12px}
  </style>
</head>
<body>
  <h1>E3 Achievement Daily Participant Evaluation</h1>

  <div class="row">
    <div class="field"><div class="label">Name:</div><div class="value">⟦record_meta.participant_label⟧</div></div>
    <div class="field"><div class="label">ID #</div><div class="value">⟦record_meta.participant_code⟧</div></div>
    <div class="field"><div class="label">Diag. Codes</div><div class="value">⟦record_meta.diag_codes⟧</div></div>
    <div class="field"><div class="label">Date</div><div class="value">⟦record_meta.date⟧</div></div>
  </div>
  <div class="row">
    <div class="field"><div class="label">Time In</div><div class="value">⟦session.time_in⟧</div></div>
    <div class="field"><div class="label">Time Out</div><div class="value">⟦session.time_out⟧</div></div>
    <div class="field"><div class="label">Total Units</div><div class="value">⟦session.total_units⟧</div></div>
    <div class="field"><div class="label">Staff Assigned</div><div class="value">⟦record_meta.assigned_staff_id⟧</div></div>
  </div>
  <div class="row">
    <div class="field"><div class="label">Eval ID</div><div class="value">⟦record_meta.eval_id⟧</div></div>
    <div class="field"><div class="label">Batch</div><div class="value">⟦record_meta.batch_id⟧</div></div>
    <div class="field"><div class="label">Instance #</div><div class="value">⟦record_meta.instance_seq⟧</div></div>
    <div class="field"><div class="label">Generated</div><div class="value">⟦record_meta.generated_at⟧</div></div>
  </div>

  <div class="field"><div class="label">Goals:</div><div class="value">⟦program_goals_summary⟧</div></div>
  <div class="field"><div class="label">Today's Focus:</div><div class="value">⟦todays_focus⟧</div></div>

  <div class="legend no-print controls"><strong>Selection rule:</strong> choose exactly one box per row (Yes, NI, or N/A). The page will keep only one checked per row.</div>

  <div class="section">
    <h2>Work Habits</h2>
    <table>
      <colgroup><col class="w-40"/><col/><col/><col/></colgroup>
      <thead><tr><th>Item</th><th>Yes</th><th>NI</th><th>N/A</th></tr></thead>
      <tbody>
        <tr>
          <td>Attendance — Correct day and time?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.attendance.correct_day_time" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.attendance.correct_day_time" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.attendance.correct_day_time" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Attendance — Excessive absences?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.attendance.excessive_absences" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.attendance.excessive_absences" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.attendance.excessive_absences" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Timeliness — Arrived on time?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.timeliness.arrived_on_time" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.timeliness.arrived_on_time" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.timeliness.arrived_on_time" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Timeliness — Excessive tardiness?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.timeliness.excessive_tardiness" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.timeliness.excessive_tardiness" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.timeliness.excessive_tardiness" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Hygiene — Participant was appropriately groomed?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.hygiene" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.hygiene" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.hygiene" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Dress — Participant was appropriately dressed?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.dress" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.dress" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.dress" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Attitude — Participant exhibited positive attitude?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.attitude" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.attitude" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="work_habits.attitude" data-opt="na"><span>N/A</span></label></td>
        </tr>
      </tbody>
    </table>
    <div class="label">Comments:</div>
    <div class="note">⟦work_habits.comments⟧</div>
  </div>

  <div class="section">
    <h2>Preparatory Goals</h2>
    <table>
      <colgroup><col class="w-40"/><col/><col/><col/></colgroup>
      <thead><tr><th>Item</th><th>Yes</th><th>NI</th><th>N/A</th></tr></thead>
      <tbody>
        <tr>
          <td>Attention Span — adequate span for tasks?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.attention_span" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.attention_span" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.attention_span" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Following Directions — followed simple instructions?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.following_directions_simple" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.following_directions_simple" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.following_directions_simple" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Following Directions — followed multi-step instructions?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.following_directions_multi_step" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.following_directions_multi_step" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.following_directions_multi_step" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Task Completion — stayed on task?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.task_completion_stayed_on_task" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.task_completion_stayed_on_task" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.task_completion_stayed_on_task" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Task Completion — completed task being worked on?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.task_completion_completed_task" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.task_completion_completed_task" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.task_completion_completed_task" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Motor Skills — exhibits improvement?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.motor_skills_improvement" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.motor_skills_improvement" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.motor_skills_improvement" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Problem Solving — able to solve presented problems?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.problem_solving" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.problem_solving" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.problem_solving" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Safety — followed safety procedures?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.safety_procedures" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.safety_procedures" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.safety_procedures" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Change — ability to adapt to presented changes?</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.change_adaptation" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.change_adaptation" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="preparatory_goals.change_adaptation" data-opt="na"><span>N/A</span></label></td>
        </tr>
      </tbody>
    </table>
    <div class="label">Comments:</div>
    <div class="note">⟦preparatory_goals.comments⟧</div>
  </div>

  <div class="section">
    <h2>Interests / Abilities</h2>
    <table>
      <colgroup><col class="w-40"/><col/><col/><col/></colgroup>
      <thead><tr><th>Item</th><th>Yes</th><th>NI</th><th>N/A</th></tr></thead>
      <tbody>
        <tr>
          <td>Interests — increased awareness of areas of interest</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="interests_abilities.interests_awareness" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="interests_abilities.interests_awareness" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="interests_abilities.interests_awareness" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Abilities — increased awareness of talents / abilities</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="interests_abilities.abilities_awareness" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="interests_abilities.abilities_awareness" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="interests_abilities.abilities_awareness" data-opt="na"><span>N/A</span></label></td>
        </tr>
        <tr>
          <td>Transferable Skills — understanding of transferable skills</td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="interests_abilities.transferable_skills" data-opt="yes"><span>Yes</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="interests_abilities.transferable_skills" data-opt="ni"><span>NI</span></label></td>
          <td class="chkcell"><label class="chkwrap"><input type="checkbox" data-key="interests_abilities.transferable_skills" data-opt="na"><span>N/A</span></label></td>
        </tr>
      </tbody>
    </table>
    <div class="label">Comments:</div>
    <div class="note">⟦interests_abilities.comments⟧</div>
  </div>

  <div class="section">
    <h2>Commentary (Observational Tone)</h2>
    <div class="note">⟦commentary.session_note⟧</div>
    <p class="small">Tip: can be AI-generated from profile/goals/focus. Example token available: ⟦commentary.autogen⟧.</p>
  </div>

  <div class="section">
    <p>I have worked with this program participant during classroom and/or production time and have made the above observations.</p>
    <div class="sign-row">
      <div class="field"><div class="label">Instructor</div><div class="value">⟦record_meta.instructor_id⟧</div></div>
      <div class="field"><div class="label">Signature</div><div class="value">⟦signoff.instructor_signed⟧</div></div>
      <div class="field"><div class="label">Date</div><div class="value">⟦signoff.signature_timestamp⟧</div></div>
    </div>
    <div class="field" style="margin-top:8px;"><div class="label">Signoff Notes:</div><div class="value">⟦signoff.notes⟧</div></div>
    <div class="counts">
      <div class="field"><div class="label"># STAFF PRESENT</div><div class="value">⟦session.headcount.staff⟧</div></div>
      <div class="field"><div class="label"># STUDENTS PRESENT</div><div class="value">⟦session.headcount.students⟧</div></div>
    </div>
  </div>

  <script>
    (function(){
      const state = {};
      function updateGroup(key, opt, el){
        document.querySelectorAll('input[type="checkbox"][data-key="'+key+'"]').forEach(cb=>{ if(cb !== el) cb.checked = false; });
        state[key] = el.checked ? opt : "";
      }
      document.querySelectorAll('input[type="checkbox"][data-key]').forEach(cb=>{
        const key = cb.getAttribute('data-key'); const opt = cb.getAttribute('data-opt');
        cb.addEventListener('change', () => updateGroup(key, opt, cb));
      });
      window.formState = state;
    })();
  </script>
  <script>
    (function(){
      function norm(val){
        const s = String(val).trim().toLowerCase();
        const map = { "yes":"yes","y":"yes","true":"yes","1":"yes","ni":"ni","no":"ni","false":"ni","0":"ni","n/a":"na","na":"na","none":"na" };
        return map[s];
      }
      function apply(initial){
        if(!initial) return;
        Object.entries(initial).forEach(([key,val])=>{
          const opt = norm(val); if(!opt) return;
          const sel = 'input[type="checkbox"][data-key="'+key+'"][data-opt="'+opt+'"]';
          const cb = document.querySelector(sel);
          if(cb){ cb.checked = true; cb.dispatchEvent(new Event('change')); }
        });
      }
      if(document.readyState!=="loading") apply(window.initialChecks);
      else document.addEventListener('DOMContentLoaded', ()=>apply(window.initialChecks));
    })();
  </script>
</body>
</html>

  </script>

<script>
(function(){
  const $ = (sel)=>document.querySelector(sel);

  // ---------- Identifier helpers ----------
  let BATCH_ID = null;
  let INSTANCE_COUNTER = 1;
  let TESTED_OK = false;

  function pad(n,w=2){ return String(n).padStart(w,'0'); }
  function yyyymmdd(d){ return d.getFullYear()+pad(d.getMonth()+1)+pad(d.getDate()); }
  function hhmmss(d){ return pad(d.getHours())+pad(d.getMinutes())+pad(d.getSeconds()); }
  function randHex(n=4){ const b=new Uint8Array(Math.ceil(n/2)); crypto.getRandomValues(b); return Array.from(b,x=>x.toString(16).padStart(2,'0')).join('').slice(0,n); }
  function genBatchId(){ const d=new Date(); return `B${yyyymmdd(d)}${hhmmss(d)}-${randHex(4)}`; }
  function genEvalId(){ const d=new Date(); return `E3-${yyyymmdd(d)}-${hhmmss(d)}-${randHex(4)}`; }

  function fillIdentifiers(data, instanceSeq){
    if(!$('#autoIds').checked) return;
    const now = new Date();
    data.record_meta = data.record_meta || {};
    data.record_meta.batch_id = BATCH_ID;
    data.record_meta.instance_seq = instanceSeq;
    data.record_meta.eval_id = genEvalId();
    data.record_meta.generated_at = now.toISOString();
  }

  function runIdTest(n=200){
    const set=new Set();
    for(let i=0;i<n;i++){
      const id=genEvalId();
      if(set.has(id)) return {ok:false, dup:id, seen:set.size};
      set.add(id);
    }
    return {ok:true, count:set.size, sample:Array.from(set).slice(0,5)};
  }

  // ---------- Utils ----------
  function sanitizeFilename(name){
    return name.replace(/[\/:*?"<>|]+/g,'-').replace(/\s+/g,' ').trim();
  }
  function pathGet(obj, path){
    try{ return path.split('.').reduce((o,k)=>o && o[k]!==undefined ? o[k] : '', obj) ?? ''; }
    catch(e){ return ''; }
  }
  function pathSet(obj, path, value){
    const segs = path.split('.'); let cur = obj;
    for(let i=0;i<segs.length-1;i++){ cur[segs[i]] ??= {}; cur = cur[segs[i]]; }
    cur[segs[segs.length-1]] = value;
  }
  function replaceTokens(tpl, data){
    return tpl.replace(/⟦([^⟧]+)⟧/g, (_,p)=>{
      const v = pathGet(data, p.trim());
      return (v===undefined || v===null) ? '' : String(v);
    });
  }
  function gleanChecksFromData(data){
    const allowed = new Set(['yes','ni','na','y','true','1','no','false','0','n/a','none']);
    const out = {};
    (function walk(prefix, obj){
      if(!obj || typeof obj!=='object') return;
      for(const k of Object.keys(obj)){
        const val = obj[k];
        const path = prefix ? prefix + '.' + k : k;
        if(typeof val==='string' || typeof val==='number' || typeof val==='boolean'){
          const s = String(val).trim().toLowerCase();
          if(allowed.has(s)){ out[path] = s; }
        } else if (typeof val==='object'){
          walk(path, val);
        }
      }
    })('', data);
    return out;
  }
  function injectPrecheckScript(html, checksObj){
    const payload = JSON.stringify(checksObj || {});
    const script = `<script>window.initialChecks = ${payload};</script>`;
    if(/<\/body>/i.test(html)){
      return html.replace(/<\/body>/i, script + "\n</body>");
    }
    return html + script;
  }
  function makeChildHTML(tpl, data){
    const checks = gleanChecksFromData(data);
    let html = replaceTokens(tpl, data);
    html = injectPrecheckScript(html, checks);
    return html;
  }
  function collectBaseData(){
    let obj = {};
    const raw = $('#dataJson').value.trim();
    if(raw){
      try{ obj = JSON.parse(raw); }catch(e){ alert('Base data JSON is invalid.'); throw e; }
    }
    return obj;
  }
  function download(name, content, type='text/html'){
    const blob = new Blob([content], {type});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 800);
  }
  function replaceFilePattern(pattern, data){
    const safe = replaceTokens(pattern, data) || 'E3-Child.html';
    return sanitizeFilename(safe);
  }

  // ---------- AEON-Bridge v1.1 helpers ----------
  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  function stableStringify(obj){
    function sortKeys(x){
      if(Array.isArray(x)) return x.map(sortKeys);
      if(x && typeof x === 'object'){
        const out = {};
        Object.keys(x).sort().forEach(k=>{ out[k] = sortKeys(x[k]); });
        return out;
      }
      return x;
    }
    return JSON.stringify(sortKeys(obj), null, 0);
  }
  async function buildChecklist({data, html, tpl, fileName, attempt}){
    const now = new Date().toISOString();
    const artifact_id = crypto.randomUUID();
    const artifact_sha = await sha256Hex(html);
    const plan_sha = await sha256Hex(tpl);
    const cycle_mobius_seal = await sha256Hex(plan_sha + '.' + artifact_sha);

    const base = {
      version: "1.1.0",
      artifact_id,
      created: now,
      updated: now,
      description: "E3 child evaluation artifact (HTML) emitted by offline master builder.",
      phases: { summon: "IDs + token overlay", echo: "Child HTML emission + seals" },
      glyphs: { infinity:"∞", phi:"φ", therefore:"∴", psi:"ψ", delta:"Δ", emptyset:"∅" },
      steps: [{
        step_id: crypto.randomUUID(),
        phase: "echo",
        glyph: "∴",
        title: "Emit child and attach cryptographic seals",
        timestamp: now,
        entropy: 0.65,
        contested: false,
        tags: ["e3","child","html","seal"],
        status: "completed",
        result: "ok",
        recursion_depth: 0,
        validation_history: [{ cycle: 1, entropy: 0.65, contested: false, disagreement: 0 }]
      }],
      seal: { algo: "sha256", hash: "", timestamp: now },
      final_mobius_seal: "",
      cycles: [{
        attempt: attempt,
        timestamp: now,
        plan_sha,
        artifact_sha,
        cycle_mobius_seal,
        metrics: {},
        reflection: {}
      }],
      canonicalization: "UTF-8, sort_keys=true, separators=(',',':'), ensure_ascii=false. Excl. seals.",
      metadata: {
        file_name: fileName,
        file_pattern: document.getElementById('filePattern').value,
        batch_id: (data && data.record_meta && data.record_meta.batch_id) || "",
        eval_id: (data && data.record_meta && data.record_meta.eval_id) || "",
        instance_seq: (data && data.record_meta && data.record_meta.instance_seq) || "",
        participant_code: (data && data.record_meta && data.record_meta.participant_code) || "",
        date: (data && data.record_meta && data.record_meta.date) || ""
      }
    };

    // Compute final_mobius_seal on canonicalized copy excluding seals
    const copyForSeal = JSON.parse(JSON.stringify(base));
    delete copyForSeal.seal;
    delete copyForSeal.final_mobius_seal;
    const canonical = stableStringify(copyForSeal);
    const final_mobius_seal = await sha256Hex(canonical);

    // Bind primary seal to both final_mobius_seal and artifact_sha
    const primarySeal = await sha256Hex(final_mobius_seal + '.' + artifact_sha);

    base.final_mobius_seal = final_mobius_seal;
    base.seal.hash = primarySeal;

    return base;
  }

  async function maybeEmitChecklist({data, html, tpl, fileName, attempt}){
    if(!document.getElementById('emitChecklist').checked) return;
    const checklist = await buildChecklist({data, html, tpl, fileName, attempt});
    const jsonName = fileName.replace(/\.html?$/i,'') + '.aeon.json';
    download(jsonName, JSON.stringify(checklist, null, 2), 'application/json');
  }

  // ---------- Init ----------
  function init(){
    const def = document.getElementById('defaultChild').textContent;
    document.getElementById('editor').value = def.trim();
    BATCH_ID = sessionStorage.getItem('e3_batch_id') || genBatchId();
    sessionStorage.setItem('e3_batch_id', BATCH_ID);
    document.getElementById('batchId').value = BATCH_ID;
    INSTANCE_COUNTER = parseInt(document.getElementById('instanceStart').value||'1',10);
  }

  // ---------- Events ----------
  document.getElementById('regenBatch').addEventListener('click', ()=>{
    BATCH_ID = genBatchId();
    sessionStorage.setItem('e3_batch_id', BATCH_ID);
    document.getElementById('batchId').value = BATCH_ID;
  });
  document.getElementById('instanceStart').addEventListener('input', ()=>{
    const v = parseInt(document.getElementById('instanceStart').value||'1',10);
    INSTANCE_COUNTER = isNaN(v)?1:v;
  });
  document.getElementById('testIds').addEventListener('click', ()=>{
    const tc = parseInt(document.getElementById('testCount').value||'200',10);
    const res = runIdTest(tc);
    const log = document.getElementById('testLog');
    if(res.ok){
      TESTED_OK = true;
      log.textContent = `PASS: ${res.count} unique IDs in ${tc} runs. Sample:\n` + res.sample.join('\n');
    }else{
      TESTED_OK = false;
      log.textContent = `FAIL: duplicate after ${res.seen} runs -> ${res.dup}`;
    }
  });
  document.getElementById('resetTpl').addEventListener('click', ()=>{
    if(confirm('Reset editor to default child template? Your current edits will be lost.')){
      const def = document.getElementById('defaultChild').textContent;
      document.getElementById('editor').value = def.trim();
    }
  });
  document.getElementById('btnPreview').addEventListener('click', ()=>{
    const tpl = document.getElementById('editor').value;
    const data = collectBaseData();
    fillIdentifiers(data, INSTANCE_COUNTER);
    const html = makeChildHTML(tpl, data);
    document.getElementById('preview').srcdoc = html;
  });

  // Make download handlers async to allow hashing
  document.getElementById('btnDownloadOne').addEventListener('click', async ()=>{
    const tpl = document.getElementById('editor').value;
    const data = collectBaseData();
    fillIdentifiers(data, INSTANCE_COUNTER++);
    const html = makeChildHTML(tpl, data);
    const name = replaceFilePattern(document.getElementById('filePattern').value, data);
    download(name, html);
    await maybeEmitChecklist({data, html, tpl, fileName: name, attempt: 1});
  });

  document.getElementById('btnBulk').addEventListener('click', ()=>{
    const file = document.getElementById('bulkFile').files[0];
    if(!file) { alert('Choose a bulk JSON file (array of objects).'); return; }
    if(!TESTED_OK){
      const tc = parseInt(document.getElementById('testCount').value||'200',10);
      const res = runIdTest(tc);
      const log = document.getElementById('testLog');
      if(res.ok){
        TESTED_OK = true;
        log.textContent = `Auto-test passed (${res.count} unique). Sample:\n`+res.sample.join('\n');
      } else {
        alert('Identifier test failed: duplicate '+res.dup+' after '+res.seen+' generations. Aborting bulk export.');
        return;
      }
    }
    const reader = new FileReader();
    reader.onload = async (e)=>{
      try{
        const arr = JSON.parse(e.target.result);
        if(!Array.isArray(arr)) throw new Error('Bulk JSON must be an array.');
        const base = collectBaseData();
        const tpl = document.getElementById('editor').value;
        let idx = parseInt(document.getElementById('instanceStart').value||'1',10);
        let count = 0;
        for(let i=0;i<arr.length;i++){
          const row = arr[i] || {};
          const data = JSON.parse(JSON.stringify(base));
          if(!Array.isArray(row)){
            for(const [k,v] of Object.entries(row)){
              if(k.includes('.')) pathSet(data, k, v);
              else if(typeof v==='object' && v!==null) data[k] = Object.assign(data[k]||{}, v);
              else data[k] = v;
            }
          }
          fillIdentifiers(data, idx++);
          const html = makeChildHTML(tpl, data);
          const fname = replaceFilePattern(document.getElementById('filePattern').value, data) || `E3-Child-${i+1}.html`;
          download(fname, html);
          await maybeEmitChecklist({data, html, tpl, fileName: fname, attempt: i+1});
          count++;
        }
        alert(`Exported ${count} file(s).`);
      } catch(err){
        alert('Bulk JSON parse failed: '+err.message);
      }
    };
    reader.readAsText(file);
  });

  init();
})();
</script>
</body>
</html>
