<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>E3 Master Builder - Ultra Simple</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
    .container { max-width: 900px; margin: 0 auto; }
    .section { background: #f9f9f9; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 20px; }
    .form-row { display: flex; gap: 15px; margin-bottom: 10px; align-items: center; }
    .form-row > * { flex: 1; }
    label { display: block; font-weight: bold; margin-bottom: 5px; }
    input, textarea, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 3px; font-family: inherit; }
    button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 3px; cursor: pointer; font-size: 14px; }
    button:hover { background: #0056b3; }
    button.secondary { background: #6c757d; }
    textarea.code { font-family: monospace; font-size: 12px; }
    #template { height: 200px; }
    #baseData { height: 100px; }
    #preview { width: 100%; height: 300px; border: 1px solid #ccc; }
    .status { padding: 10px; border-radius: 3px; margin: 10px 0; }
    .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .mono { font-family: monospace; }
  </style>
</head>
<body>
  <div class="container">
    <h1>E3 Master Builder - Ultra Simple</h1>
    
    <div class="section">
      <h3>Step 1: Setup</h3>
      <div class="form-row">
        <div>
          <label>Batch ID</label>
          <input type="text" id="batchId" class="mono" readonly>
        </div>
        <div>
          <button type="button" id="newBatch">New Batch</button>
        </div>
        <div>
          <label>Counter</label>
          <input type="number" id="counter" value="1" min="1">
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Step 2: Base Data (Optional)</h3>
      <label>JSON data to merge into all children</label>
      <textarea id="baseData" class="code" placeholder='{"record_meta": {"date": "2025-08-09"}}'></textarea>
    </div>

    <div class="section">
      <h3>Step 3: Template</h3>
      <div class="form-row">
        <button type="button" id="resetTemplate" class="secondary">Load Default E3 Template</button>
      </div>
      <label>Child Template (use ⟦token⟧ syntax for replacements)</label>
      <textarea id="template" class="code"></textarea>
    </div>

    <div class="section">
      <h3>Step 4: Actions</h3>
      <div class="form-row">
        <button type="button" id="preview">Preview</button>
        <button type="button" id="downloadOne">Download Single</button>
      </div>
      <div class="form-row">
        <input type="file" id="bulkFile" accept=".json">
        <button type="button" id="bulkExport">Bulk Export</button>
      </div>
      <div id="status"></div>
    </div>

    <div class="section">
      <h3>Preview</h3>
      <iframe id="preview"></iframe>
    </div>
  </div>

<script>
// Simple globals
let batchId = '';
let counter = 1;

// Simple utility functions
function makeId() {
  const now = new Date();
  const date = now.getFullYear() + 
    String(now.getMonth() + 1).padStart(2, '0') + 
    String(now.getDate()).padStart(2, '0');
  const time = String(now.getHours()).padStart(2, '0') + 
    String(now.getMinutes()).padStart(2, '0') + 
    String(now.getSeconds()).padStart(2, '0');
  const random = Math.random().toString(36).substr(2, 4);
  return date + time + random;
}

function showStatus(message, isError = false) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = 'status ' + (isError ? 'error' : 'success');
}

function replaceTokens(template, data) {
  return template.replace(/⟦([^⟧]+)⟧/g, function(match, token) {
    const path = token.trim().split('.');
    let value = data;
    
    for (let key of path) {
      if (value && typeof value === 'object' && key in value) {
        value = value[key];
      } else {
        return ''; // Token not found, return empty
      }
    }
    
    return value == null ? '' : String(value);
  });
}

function extractCheckboxes(data) {
  const result = {};
  
  function scan(obj, prefix = '') {
    for (let key in obj) {
      if (!obj.hasOwnProperty(key)) continue;
      
      const fullKey = prefix ? prefix + '.' + key : key;
      const value = obj[key];
      
      if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
        scan(value, fullKey);
      } else {
        const str = String(value).toLowerCase().trim();
        if (['yes', 'y', 'true', '1'].includes(str)) {
          result[fullKey] = 'yes';
        } else if (['ni', 'no', 'false', '0'].includes(str)) {
          result[fullKey] = 'ni';
        } else if (['na', 'n/a', 'none'].includes(str)) {
          result[fullKey] = 'na';
        }
      }
    }
  }
  
  scan(data);
  return result;
}

function buildChild(template, data) {
  // Add system data
  if (!data.record_meta) data.record_meta = {};
  data.record_meta.batch_id = batchId;
  data.record_meta.eval_id = 'E3-' + makeId();
  data.record_meta.instance_seq = counter;
  data.record_meta.generated_at = new Date().toISOString();
  
  // Replace tokens
  let html = replaceTokens(template, data);
  
  // Add checkbox script
  const checkboxes = extractCheckboxes(data);
  const script = `
<script>
window.checkboxData = ${JSON.stringify(checkboxes)};

// Apply checkboxes when page loads
document.addEventListener('DOMContentLoaded', function() {
  // One checkbox per row logic
  document.querySelectorAll('input[type="checkbox"][data-key]').forEach(function(cb) {
    cb.addEventListener('change', function() {
      if (this.checked) {
        const key = this.getAttribute('data-key');
        document.querySelectorAll('input[type="checkbox"][data-key="' + key + '"]').forEach(function(other) {
          if (other !== cb) other.checked = false;
        });
      }
    });
  });
  
  // Apply initial values
  for (let key in window.checkboxData) {
    const value = window.checkboxData[key];
    const selector = 'input[type="checkbox"][data-key="' + key + '"][data-opt="' + value + '"]';
    const checkbox = document.querySelector(selector);
    if (checkbox) {
      checkbox.checked = true;
    }
  }
});
</script>`;
  
  // Insert script before closing body tag
  if (html.includes('</body>')) {
    html = html.replace('</body>', script + '\n</body>');
  } else {
    html += script;
  }
  
  return html;
}

function download(filename, content) {
  const blob = new Blob([content], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Default template
const DEFAULT_TEMPLATE = `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>E3 Achievement Daily Participant Evaluation</title>
  <style>
    body { font: 14px Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; color: #333; }
    .row { display: flex; gap: 20px; margin-bottom: 10px; }
    .field { flex: 1; padding: 5px; border-bottom: 1px solid #ccc; }
    .label { font-weight: bold; color: #666; }
    .value { margin-top: 5px; }
    .section { margin: 20px 0; border-top: 2px solid #333; padding-top: 10px; }
    table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f5f5f5; }
    .checkbox-cell { text-align: center; }
    .comments { border: 1px dashed #999; padding: 10px; min-height: 40px; background: #fafafa; }
    @media print { body { margin: 0; font-size: 12px; } }
  </style>
</head>
<body>
  <h1>E3 Achievement Daily Participant Evaluation</h1>
  
  <div class="row">
    <div class="field">
      <div class="label">Name:</div>
      <div class="value">⟦record_meta.participant_label⟧</div>
    </div>
    <div class="field">
      <div class="label">ID:</div>
      <div class="value">⟦record_meta.participant_code⟧</div>
    </div>
    <div class="field">
      <div class="label">Date:</div>
      <div class="value">⟦record_meta.date⟧</div>
    </div>
  </div>
  
  <div class="row">
    <div class="field">
      <div class="label">Eval ID:</div>
      <div class="value">⟦record_meta.eval_id⟧</div>
    </div>
    <div class="field">
      <div class="label">Batch:</div>
      <div class="value">⟦record_meta.batch_id⟧</div>
    </div>
    <div class="field">
      <div class="label">Instance:</div>
      <div class="value">⟦record_meta.instance_seq⟧</div>
    </div>
  </div>

  <div class="section">
    <h3>Work Habits</h3>
    <table>
      <tr>
        <th style="width: 50%;">Item</th>
        <th>Yes</th>
        <th>NI</th>
        <th>N/A</th>
      </tr>
      <tr>
        <td>Attendance — Correct day and time?</td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="work_habits.attendance.correct_day_time" data-opt="yes"> Yes
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="work_habits.attendance.correct_day_time" data-opt="ni"> NI
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="work_habits.attendance.correct_day_time" data-opt="na"> N/A
        </td>
      </tr>
      <tr>
        <td>Hygiene — Participant was appropriately groomed?</td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="work_habits.hygiene" data-opt="yes"> Yes
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="work_habits.hygiene" data-opt="ni"> NI
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="work_habits.hygiene" data-opt="na"> N/A
        </td>
      </tr>
      <tr>
        <td>Attitude — Participant exhibited positive attitude?</td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="work_habits.attitude" data-opt="yes"> Yes
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="work_habits.attitude" data-opt="ni"> NI
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="work_habits.attitude" data-opt="na"> N/A
        </td>
      </tr>
    </table>
    <div class="label">Comments:</div>
    <div class="comments">⟦work_habits.comments⟧</div>
  </div>

  <div class="section">
    <h3>Preparatory Goals</h3>
    <table>
      <tr>
        <th style="width: 50%;">Item</th>
        <th>Yes</th>
        <th>NI</th>
        <th>N/A</th>
      </tr>
      <tr>
        <td>Attention Span — adequate span for tasks?</td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="preparatory_goals.attention_span" data-opt="yes"> Yes
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="preparatory_goals.attention_span" data-opt="ni"> NI
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="preparatory_goals.attention_span" data-opt="na"> N/A
        </td>
      </tr>
      <tr>
        <td>Task Completion — stayed on task?</td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="preparatory_goals.task_completion_stayed_on_task" data-opt="yes"> Yes
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="preparatory_goals.task_completion_stayed_on_task" data-opt="ni"> NI
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="preparatory_goals.task_completion_stayed_on_task" data-opt="na"> N/A
        </td>
      </tr>
      <tr>
        <td>Safety — followed safety procedures?</td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="preparatory_goals.safety_procedures" data-opt="yes"> Yes
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="preparatory_goals.safety_procedures" data-opt="ni"> NI
        </td>
        <td class="checkbox-cell">
          <input type="checkbox" data-key="preparatory_goals.safety_procedures" data-opt="na"> N/A
        </td>
      </tr>
    </table>
    <div class="label">Comments:</div>
    <div class="comments">⟦preparatory_goals.comments⟧</div>
  </div>

  <div class="section">
    <h3>Signature</h3>
    <div class="row">
      <div class="field">
        <div class="label">Instructor:</div>
        <div class="value">⟦record_meta.instructor_id⟧</div>
      </div>
      <div class="field">
        <div class="label">Date:</div>
        <div class="value">⟦record_meta.date⟧</div>
      </div>
    </div>
  </div>
</body>
</html>`;

// Initialize
function init() {
  batchId = 'B' + makeId();
  counter = 1;
  
  document.getElementById('batchId').value = batchId;
  document.getElementById('counter').value = counter;
  document.getElementById('template').value = DEFAULT_TEMPLATE;
}

// Event handlers
document.getElementById('newBatch').addEventListener('click', function() {
  batchId = 'B' + makeId();
  document.getElementById('batchId').value = batchId;
  showStatus('New batch ID generated');
});

document.getElementById('counter').addEventListener('input', function() {
  counter = parseInt(this.value) || 1;
});

document.getElementById('resetTemplate').addEventListener('click', function() {
  if (confirm('Reset to default template? Your changes will be lost.')) {
    document.getElementById('template').value = DEFAULT_TEMPLATE;
    showStatus('Template reset to default');
  }
});

document.getElementById('preview').addEventListener('click', function() {
  try {
    const template = document.getElementById('template').value;
    let data = {};
    
    const baseDataText = document.getElementById('baseData').value.trim();
    if (baseDataText) {
      data = JSON.parse(baseDataText);
    }
    
    const html = buildChild(template, data);
    document.getElementById('preview').srcdoc = html;
    showStatus('Preview generated successfully');
  } catch (error) {
    showStatus('Error: ' + error.message, true);
  }
});

document.getElementById('downloadOne').addEventListener('click', function() {
  try {
    const template = document.getElementById('template').value;
    let data = {};
    
    const baseDataText = document.getElementById('baseData').value.trim();
    if (baseDataText) {
      data = JSON.parse(baseDataText);
    }
    
    const html = buildChild(template, data);
    const filename = 'E3-Child-' + counter + '.html';
    
    download(filename, html);
    counter++;
    document.getElementById('counter').value = counter;
    showStatus('Downloaded: ' + filename);
  } catch (error) {
    showStatus('Error: ' + error.message, true);
  }
});

document.getElementById('bulkExport').addEventListener('click', function() {
  const file = document.getElementById('bulkFile').files[0];
  if (!file) {
    showStatus('Please select a JSON file first', true);
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const bulkData = JSON.parse(e.target.result);
      if (!Array.isArray(bulkData)) {
        showStatus('File must contain a JSON array', true);
        return;
      }
      
      const template = document.getElementById('template').value;
      let baseData = {};
      
      const baseDataText = document.getElementById('baseData').value.trim();
      if (baseDataText) {
        baseData = JSON.parse(baseDataText);
      }
      
      bulkData.forEach(function(rowData, index) {
        // Merge base data with row data
        const data = Object.assign({}, baseData);
        Object.assign(data, rowData);
        
        const html = buildChild(template, data);
        const filename = 'E3-Child-' + (counter + index) + '.html';
        
        setTimeout(function() {
          download(filename, html);
        }, index * 200); // Stagger downloads
      });
      
      counter += bulkData.length;
      document.getElementById('counter').value = counter;
      showStatus('Bulk export started: ' + bulkData.length + ' files');
      
    } catch (error) {
      showStatus('Error processing file: ' + error.message, true);
    }
  };
  
  reader.readAsText(file);
});

// Start the app
init();
</script>
</body>
</html>