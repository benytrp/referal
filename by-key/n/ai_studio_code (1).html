<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal AEON Bridge Viewer</title>
    <style>
        :root {
            --bg-dark: #0d121c;
            --bg-panel: #1f2937;
            --text-light: #e2e8f0;
            --text-muted: #94a3b8;
            --border-color: #374151;
            --accent-blue: #3b82f6;
            --status-ok: #10b981;
            --status-warn: #f59e0b;
            --status-err: #ef4444;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            padding: 1.5rem;
        }
        .container {
            max-width: 1400px;
            margin: auto;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1.5rem;
        }
        .card {
            background-color: var(--bg-panel);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        h1, h2 {
            margin: 0 0 1rem 0;
        }
        h1 { font-size: 1.875rem; font-weight: 700; text-align: center; grid-column: 1 / -1; }
        h2 { font-size: 1.25rem; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-muted);
        }
        .file-input {
            display: block;
            width: 100%;
            background-color: #111827;
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        .seal-display, .meta-display, .ledger-display {
            background-color: #111827;
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', Courier, monospace;
            word-break: break-all;
            white-space: pre-wrap;
            font-size: 0.875rem;
        }
        .ledger-display {
            max-height: 80vh;
            overflow-y: auto;
        }
        .status {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 600;
            text-align: center;
        }
        .status.ok { background-color: var(--status-ok); color: #ffffff; }
        .status.tampered { background-color: var(--status-err); color: #ffffff; }
        .status.pending { background-color: var(--status-warn); color: #000000; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Universal AEON Bridge Viewer</h1>

        <!-- Left Panel: Controls, Metadata, Seals -->
        <div class="card space-y-6">
            <div>
                <h2>Controls & Verification</h2>
                <label for="filePicker">Load AEON-CoT-Bridgefile.json</label>
                <input type="file" id="filePicker" class="file-input" accept=".json">
                <div id="verificationStatus" class="status pending">Awaiting File...</div>
            </div>
            <div>
                <h2>Manifest / Metadata</h2>
                <div id="metaDisplay" class="meta-display">Load a file to see metadata.</div>
            </div>
            <div>
                <h2>Cryptographic Seals</h2>
                <div id="sealsDisplay" class="seal-display">Load a file to see seals.</div>
            </div>
        </div>

        <!-- Right Panel: Thought Ledger -->
        <div class="card">
            <h2>Thought Ledger</h2>
            <div id="ledgerDisplay" class="ledger-display">Load a file to see the thought ledger.</div>
        </div>
    </div>

    <script>
        // --- UTILITY FUNCTIONS ---
        async function sha256Hex(input) {
            const data = new TextEncoder().encode(input);
            const buf = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function canonicalize(obj) {
            if (obj === null || typeof obj !== 'object') {
                return JSON.stringify(obj);
            }
            if (Array.isArray(obj)) {
                return '[' + obj.map(canonicalize).join(',') + ']';
            }
            const keys = Object.keys(obj).sort();
            const pairs = keys.map(key => `"${key}":${canonicalize(obj[key])}`);
            return '{' + pairs.join(',') + '}';
        }

        // --- DOM ELEMENTS ---
        const filePicker = document.getElementById('filePicker');
        const verificationStatus = document.getElementById('verificationStatus');
        const metaDisplay = document.getElementById('metaDisplay');
        const sealsDisplay = document.getElementById('sealsDisplay');
        const ledgerDisplay = document.getElementById('ledgerDisplay');

        // --- CORE LOGIC ---
        filePicker.addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    await processBridgeFile(data);
                } catch (err) {
                    verificationStatus.textContent = `Error: Invalid JSON file. ${err.message}`;
                    verificationStatus.className = 'status tampered';
                }
            };
            reader.readAsText(file);
        }

        async function processBridgeFile(data) {
            // 1. Render Metadata
            const manifest = data.manifest || data.meta || {};
            metaDisplay.textContent = JSON.stringify(manifest, null, 2);

            // 2. Render Thought Ledger
            const ledger = data.thought_ledger || [];
            ledgerDisplay.textContent = JSON.stringify(ledger, null, 2);

            // 3. Verify Seals
            await verifySeals(data);
        }

        async function verifySeals(data) {
            const ledger = data.thought_ledger || [];
            if (ledger.length === 0) {
                sealsDisplay.textContent = "Ledger is empty. No seals to verify.";
                verificationStatus.textContent = "Verification Pending";
                verificationStatus.className = "status pending";
                return;
            }
            
            // Create a deep copy for manipulation without altering the original object
            const dataToHash = JSON.parse(JSON.stringify(data));
            
            // Nullify the seals in the copy before hashing
            if (dataToHash.hash && dataToHash.hash.seal) {
                 delete dataToHash.hash.seal;
            }
             if (dataToHash.thought_ledger && dataToHash.thought_ledger.entries_summary) {
                 delete dataToHash.thought_ledger.entries_summary.public_ledger_seal;
                 delete dataToHash.thought_ledger.entries_summary.private_ledger_seal;
            }


            const canonicalLedger = canonicalize(ledger);
            const calculatedLedgerSeal = await sha256Hex(canonicalLedger);
            
            const originalLedgerSeal = data.thought_ledger?.entries_summary?.public_ledger_seal || "Not Found";

            let finalStatusText = '';
            let isTampered = false;

            if (calculatedLedgerSeal === originalLedgerSeal) {
                finalStatusText += `Ledger Seal: VERIFIED\n`;
            } else {
                finalStatusText += `Ledger Seal: TAMPERED\n`;
                isTampered = true;
            }
            
            finalStatusText += `  - Expected: ${originalLedgerSeal}\n`;
            finalStatusText += `  - Calculated: ${calculatedLedgerSeal}\n\n`;

            sealsDisplay.textContent = finalStatusText;

            if(isTampered) {
                verificationStatus.textContent = "Verification Failed: Data has been tampered with.";
                verificationStatus.className = "status tampered";
            } else {
                verificationStatus.textContent = "Verified: All seals match.";
                verificationStatus.className = "status ok";
            }
        }
    </script>
</body>
</html>